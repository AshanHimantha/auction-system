<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Auction System - Public List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .image-preview-card { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; }
        .countdown { font-family: monospace; font-weight: bold; }
        .auction-status {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        .status-active { background-color: #d1fae5; color: #065f46; } /* green-100 / green-800 */
        .status-waiting { background-color: #fffbeb; color: #b45309; } /* amber-100 / amber-800 */
        .status-ended { background-color: #fee2e2; color: #991b1b; } /* red-100 / red-800 */
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800">All Auctions</h1>
        <div class="flex items-center space-x-4">
            <a href="login-register.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">Login / Register</a>
            <a href="create-auction.html" id="create-auction-link-nav" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">Create Auction</a>
        </div>
    </div>

    <!-- Auction List -->
    <div id="auction-list-section">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8" id="auction-list">
            <p class="col-span-full text-center text-gray-500">Loading auctions...</p>
        </div>
    </div>
</div>

<script>
    const auctionListDiv = document.getElementById('auction-list');
    const createAuctionLinkNav = document.getElementById('create-auction-link-nav'); // Nav link

    const CONTEXT_ROOT = '/auction-system';

    // --- Utility Functions ---
    function getAuthToken() { return localStorage.getItem('authToken'); }
    function getCurrentUserRole() { return localStorage.getItem('currentUserRole'); }

    function formatTimeRemaining(endTimeString) {
        const now = new Date().getTime();
        const endTime = new Date(endTimeString).getTime();
        const distance = endTime - now;

        if (distance < 0) {
            return 'ENDED';
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        return `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    // --- Auction Listing ---
    async function fetchAuctions() {
        try {
            // No token needed for this public list
            const response = await fetch(`${CONTEXT_ROOT}/api/auctions`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const auctions = await response.json();
            auctionListDiv.innerHTML = ''; // Clear previous auctions

            if (auctions.length === 0) {
                auctionListDiv.innerHTML = '<p class="col-span-full text-center text-gray-500">No auctions available.</p>';
                return;
            }

            auctions.forEach(auction => {
                const card = createAuctionCard(auction);
                auctionListDiv.appendChild(card);
            });
        } catch (error) {
            console.error('Failed to load auctions:', error);
            auctionListDiv.innerHTML = '<p class="col-span-full text-center text-red-700">Error loading auctions. Check server status.</p>';
        }
    }

    function getAuctionStatus(auction) {
        const now = new Date();
        const startTime = new Date(auction.startTime);
        const endTime = new Date(auction.endTime);

        if (now < startTime) {
            return { text: 'WAITING', class: 'status-waiting' };
        } else if (now > endTime) {
            return { text: 'ENDED', class: 'status-ended' };
        } else {
            return { text: 'ACTIVE', class: 'status-active' };
        }
    }

    function createAuctionCard(auction) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-lg p-6 flex flex-col justify-between';

        const startTimeFormatted = new Date(auction.startTime).toLocaleString();
        const endTimeFormatted = new Date(auction.endTime).toLocaleString();

        const imageUrlsHtml = auction.imageUrls && auction.imageUrls.length > 0
            ? auction.imageUrls.map(url => `<img src="${url}" alt="Auction Image" class="image-preview-card">`).join('')
            : '<p class="text-gray-400 text-xs">No images</p>';

        const status = getAuctionStatus(auction);

        card.innerHTML = `
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">
                        <a href="${CONTEXT_ROOT}/auction-details.html?id=${auction.id}" class="hover:underline text-blue-600">${auction.title}</a>
                        <span class="text-gray-500 text-sm">(ID: ${auction.id})</span>
                    </h3>
                    <span class="auction-status ${status.class}">${status.text}</span>
                    <p class="text-gray-600 mb-2 text-sm">${auction.description.substring(0, 100)}...</p>
                    <div class="flex flex-wrap gap-2 mb-4">${imageUrlsHtml}</div>
                    <p class="text-gray-600 mb-1">Starting Price: <span class="font-bold text-green-600">$${auction.startPrice.toFixed(2)}</span></p>
                    <p class="text-gray-600 mb-2">Current Bid: <span class="font-bold text-blue-600 text-lg">$${auction.currentBid.toFixed(2)}</span></p>
                    <p class="text-gray-600 mb-4">Winning Bidder: <span class="font-medium text-gray-700">${auction.winningBidder || 'None'}</span></p>
                    <p class="text-gray-500 text-sm">Min Increment: $${auction.minIncrement.toFixed(2)}</p>
                    <p class="text-gray-500 text-xs mt-2">Starts: ${startTimeFormatted}</p>
                    <p class="text-gray-500 text-xs">Ends: ${endTimeFormatted}</p>
                    <p class="text-gray-500 text-xs">Time Left: <span class="countdown">${formatTimeRemaining(auction.endTime)}</span></p>
                </div>
            `;
        return card;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchAuctions(); // Load auctions immediately

        // Check if user is admin to show 'Create Auction' link
        const userRole = getCurrentUserRole();
        if (userRole === 'ADMIN') {
            createAuctionLinkNav.classList.remove('hidden');
        }
    });
</script>
</body>
</html>